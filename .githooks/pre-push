#!/bin/bash
# Git hook для автоматического инкремента версии перед push
# Проверяет, была ли версия уже изменена в текущем коммите, и увеличивает её только если нужно

VERSION_FILE="src/__version__.py"

# Проверяем что файл существует
if [ ! -f "$VERSION_FILE" ]; then
    echo "Ошибка: файл $VERSION_FILE не найден"
    exit 1
fi

# Читаем текущую версию из файла
current_version=$(grep -oP '__version__ = "\K[^"]+' "$VERSION_FILE")

if [ -z "$current_version" ]; then
    echo "Ошибка: не удалось прочитать версию из $VERSION_FILE"
    exit 1
fi

# Проверяем был ли файл версии изменён в этом коммите
# Если в последнем коммите файл версии был затронут, пропускаем автоинкремент
if git diff-tree --no-commit-id --name-only -r HEAD | grep -q "^$VERSION_FILE$"; then
    echo "ℹ️  Версия обновлена в текущем коммите ($current_version), пропускаем автоматическое увеличение"
    exit 0
fi

# Парсим версию (формат: major.minor.patch)
IFS='.' read -r major minor patch <<< "$current_version"

# Инкрементируем patch версию
new_patch=$((patch + 1))
new_version="$major.$minor.$new_patch"

# Обновляем файл версии
echo "__version__ = \"$new_version\"" > "$VERSION_FILE"
echo ""  >> "$VERSION_FILE"

# Добавляем изменённый файл в staging
git add "$VERSION_FILE"

# Делаем amend последнего коммита с новой версией (без редактирования сообщения)
git commit --amend --no-edit --no-verify

echo "✅ Версия обновлена: $current_version → $new_version (добавлена в последний коммит)"

exit 0
