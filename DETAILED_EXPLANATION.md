# –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞ 1: Short UUID –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ –±—ç–∫–∞–ø–∞

### –ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –±—ç–∫–∞–ø PostgreSQL:
1. –í –ë–î –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∏—Ö URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://sub.dfc-online.com/puc8b5n_xfebh6sg`)
2. Short UUID –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ URL (`puc8b5n_xfebh6sg`)
3. –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ —Å –ø–∞–Ω–µ–ª—å—é:
   - –ë–æ—Ç –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ telegram_id
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞–º —É–∂–µ –µ—Å—Ç—å ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥)
   - –ù–æ short_uuid –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (—ç—Ç–æ –ø–æ–ª–µ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ API)
   - **–ü–†–û–ë–õ–ï–ú–ê:** URL –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ != URL –≤ –ë–î

### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | URL –ø–æ–¥–ø–∏—Å–∫–∏ |
|-----------|-------------|
| –ë–î (–∏–∑ –±—ç–∫–∞–ø–∞) | `https://sub.dfc-online.com/puc8b5n_xfebh6sg` |
| –ü–∞–Ω–µ–ª—å (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ) | `https://sub.dfc-online.com/ABC123XYZ` |
| –†–µ–∑—É–ª—å—Ç–∞—Ç | ‚ùå –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ |

### –†–µ—à–µ–Ω–∏–µ

–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤ `create_user(..., force=True)`:

```python
if subscription and subscription.url:
    desired_short_uuid = subscription.url.rstrip('/').split('/')[-1]
    # –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å short_uuid –∏–∑ –±—ç–∫–∞–ø–∞
    need_recreate = True

if need_recreate:
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await self.remnawave.users.delete_user(old_remna_user.uuid)
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º short_uuid
    created = await _do_create()
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | URL –ø–æ–¥–ø–∏—Å–∫–∏ |
|-----------|-------------|
| –ë–î (–∏–∑ –±—ç–∫–∞–ø–∞) | `https://sub.dfc-online.com/puc8b5n_xfebh6sg` |
| –ü–∞–Ω–µ–ª—å (–ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è) | `https://sub.dfc-online.com/puc8b5n_xfebh6sg` |
| –†–µ–∑—É–ª—å—Ç–∞—Ç | ‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ |

---

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ–≤–æ–¥—ã" –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

```python
# settings.py
class TransferSettingsDto(TrackableDto):
    enabled: bool = False  # ‚Üê –û–¢–ö–õ–Æ–ß–ï–ù–ê
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –±–æ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ–≤–æ–¥—ã" –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∞
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é –≤–∫–ª—é—á–∏—Ç—å –≤ Dashboard ‚Üí Settings ‚Üí –ü–µ—Ä–µ–≤–æ–¥—ã
- –ù–µ—É–¥–æ–±–Ω–æ –∏ –Ω–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ

### –†–µ—à–µ–Ω–∏–µ

```python
# settings.py (–ù–û–í–û–ï)
class TransferSettingsDto(TrackableDto):
    enabled: bool = True  # ‚Üê –í–ö–õ–Æ–ß–ï–ù–ê
```

–ü–ª—é—Å –º–∏–≥—Ä–∞—Ü–∏—è –ë–î:
```sql
UPDATE settings
SET features = jsonb_set(
    features::jsonb,
    '{transfers,enabled}',
    'true'::jsonb,
    true
)
WHERE features IS NOT NULL
```

---

## Flow –¥–∏–∞–≥—Ä–∞–º–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞

### –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–ü–†–û–ë–õ–ï–ú–ê)

```
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
    ‚Üì
sync_all_users_from_bot_to_panel_task
    ‚Üì
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    ‚îú‚îÄ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–∞–Ω–µ–ª–∏? ‚Üí –î–∞
    ‚îÇ   ‚îî‚îÄ updated_user() ‚Üí –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    ‚îÇ       ‚îî‚îÄ ‚ùå short_uuid –û–°–¢–ê–ï–¢–°–Ø –°–¢–ê–†–´–ú
    ‚îÇ
    ‚îî‚îÄ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí create_user(force=True)
        ‚îî‚îÄ ‚úÖ short_uuid –°–û–ó–î–ê–ï–¢–°–Ø –ù–û–í–´–ô

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ï–°–û–í–ü–ê–î–ï–ù–ò–ï URL
```

### –ù–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–†–ï–®–ï–ù–ò–ï)

```
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
    ‚Üì
sync_all_users_from_bot_to_panel_task
    ‚Üì
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    ‚îú‚îÄ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–∞–Ω–µ–ª–∏? ‚Üí –î–∞
    ‚îÇ   ‚îú‚îÄ –ï—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞ —Å URL? ‚Üí –î–∞
    ‚îÇ   ‚îÇ   ‚îî‚îÄ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å –Ω—É–∂–Ω—ã–º short_uuid
    ‚îÇ   ‚îÇ       ‚îú‚îÄ delete_user(old_uuid)
    ‚îÇ   ‚îÇ       ‚îî‚îÄ create_user(short_uuid=–Ω—É–∂–Ω—ã–π)
    ‚îÇ   ‚îÇ           ‚îî‚îÄ ‚úÖ short_uuid –°–û–í–ü–ê–î–ê–ï–¢
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ –ù–µ—Ç URL ‚Üí update (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    ‚îÇ
    ‚îî‚îÄ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí create_user(force=True)
        ‚îî‚îÄ ‚úÖ short_uuid –°–û–ó–î–ê–ï–¢–°–Ø –ù–û–í–´–ô

–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –°–û–í–ü–ê–î–ï–ù–ò–ï URL
```

---

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –£—Å–ø–µ—à–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```
INFO: Extracted short_uuid from URL: puc8b5n_xfebh6sg
INFO: Creating RemnaUser 'remnashop_855511342' from subscription '–°—Ç–∞–Ω–¥–∞—Ä—Ç'
INFO: Found existing user by telegram_id '855511342': uuid=e125449c-6417-40ca-8077-b9983d3cae6c, short_uuid=ABC123XYZ
INFO: short_uuid from backup: puc8b5n_xfebh6sg, existing in panel: ABC123XYZ. Will recreate user to ensure consistency.
INFO: Deleting user e125449c-6417-40ca-8077-b9983d3cae6c to recreate with correct short_uuid
INFO: User recreated successfully with short_uuid=puc8b5n_xfebh6sg
INFO: ‚úì User updated: StaySaved (telegram_id: 855511342, panel_uuid: e125449c-6417-40ca-8077-b9983d3cae6c)
```

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```
$ alembic upgrade head

INFO  [alembic.runtime.migration] Context impl PostgresqlImpl with table alembic_version
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 0034 -> 0035, enable_transfers_by_default

UPDATE settings SET features = jsonb_set(...); -- 1 row updated
```

---

## –ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

### Short UUID –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
1. ‚úÖ `create_user(..., force=True)` —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ URL
2. ‚úÖ –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ –±—ç–∫–∞–ø–∞ SQL
3. ‚úÖ –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ ‚Üí –ø–∞–Ω–µ–ª—å
4. ‚ùå –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (–ø–∞–Ω–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º–∞)
5. ‚ùå –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–µ–∑ `force=True`

### –í–∫–ª—é—á–µ–Ω–∏–µ "–ü–µ—Ä–µ–≤–æ–¥–æ–≤":
1. ‚úÖ –í—Å–µ –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –±–æ—Ç–∞
2. ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ë–î (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–π

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞—Ç

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:
- UUID (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —è–≤–Ω–æ)
- –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–ø–∏—Å–∫–∏ (—Ç—Ä–∞—Ñ–∏–∫, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è)
- Telegram ID (—Å–≤—è–∑—å —Å –±–æ—Ç–æ–º)
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

‚ùå –ò–∑–º–µ–Ω—è–µ—Ç—Å—è:
- Short UUID (—Ü–µ–ª–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ!)
- Subscription URL (—Å–ª–µ–¥—É–µ—Ç –∏–∑ short_uuid)

### –û—Ç–∫–∞—Ç –ë–î

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ:

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade 0034

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã
UPDATE settings SET features = jsonb_set(features::jsonb, '{transfers,enabled}', 'false'::jsonb, true);
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### –î–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ short_uuid –≤ –ø–∞–Ω–µ–ª–∏
curl -X GET "http://remnawave:3000/api/v1/users" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker compose logs -f remnashop-bot | grep -A5 "short_uuid"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
for user in $(docker compose logs remnashop-bot | grep "short_uuid from backup" | awk '{print $NF}'); do
  echo "Checking $user"
done
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

```
Dashboard ‚Üí Settings ‚Üí –ü–µ—Ä–µ–≤–æ–¥—ã
–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–Ω–æ–ø–∫–∞ "üü¢" (–≤–∫–ª—é—á–µ–Ω–æ)
```
